<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Monitors</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous"/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-gray-800 m-0 p-0 font-sans">
<div class="max-w-7xl mx-auto p-4 sm:p-6 my-2 sm:my-4">
  <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-4">
    <h1 class="text-2xl sm:text-3xl font-bold tracking-tight flex items-center gap-2.5 mb-2">
      <i class="fa-solid fa-globe"></i> Website Monitors
    </h1>
    <p class="text-gray-600 text-sm sm:text-base mb-3">Monitor multiple websites and view their uptime status at a glance</p>
    <div class="flex items-center gap-2">
      <a href="https://github.com/OWASP-BLT/OWASP-BLT-Website-Monitor/actions/workflows/website-monitor.yml" target="_blank" class="inline-block">
        <img alt="Website Monitor Status" src="https://github.com/OWASP-BLT/OWASP-BLT-Website-Monitor/actions/workflows/website-monitor.yml/badge.svg">
      </a>
      <a href="https://github.com/OWASP-BLT/OWASP-BLT-Website-Monitor" target="_blank">
        <img alt="GitHub stars" src="https://img.shields.io/github/stars/OWASP-BLT/OWASP-BLT-Website-Monitor?style=social">
      </a>
      <a href="https://github.com/OWASP-BLT/OWASP-BLT-Website-Monitor/fork" target="_blank" class="inline-flex items-center gap-1">
        <img alt="GitHub forks" src="https://img.shields.io/github/forks/OWASP-BLT/OWASP-BLT-Website-Monitor?style=social">
      </a>
    </div>
  </div>
  
  <div id="monitors-list" class="space-y-3">
    <!-- Monitor cards will be inserted here -->
  </div>
</div>
<script>
// Fetch monitors configuration
fetch('monitors.json')
  .then(r => r.json())
  .then(monitors => {
    const container = document.getElementById('monitors-list');
    
    monitors.forEach(monitor => {
      // Determine the CSV file name - try the new pattern first, fall back to status.csv
      const csvFile = monitors.length > 1 ? `status-${monitor.id}.csv` : 'status.csv';
      
      fetch(csvFile)
        .then(r => r.text())
        .then(csv => {
          const rows = parseCSV(csv);
          const lastRow = rows[rows.length - 1];
          
          // Create monitor card
          const card = createMonitorCard(monitor, rows, lastRow, csvFile);
          container.appendChild(card);
        })
        .catch(err => {
          console.error(`Failed to load data for ${monitor.id}:`, err);
          // Create card with error state
          const card = createMonitorCard(monitor, [], null, csvFile);
          container.appendChild(card);
        });
    });
  })
  .catch(err => {
    console.error('Failed to load monitors configuration:', err);
    document.getElementById('monitors-list').innerHTML = 
      '<div class="bg-red-100 text-red-800 border border-red-200 rounded-lg p-4 text-center">Failed to load monitors configuration</div>';
  });

function parseCSV(csv) {
  const lines = csv.trim().split('\n');
  return lines.filter(l => !/^\s*datetime\s*,/i.test(l)).map(l => l.split(','));
}

function createMonitorCard(monitor, rows, lastRow, csvFile) {
  const card = document.createElement('a');
  card.href = `monitor.html?id=${monitor.id}`;
  card.className = 'block bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-4 cursor-pointer';
  
  // Calculate status
  let status = 'unknown';
  let statusColor = 'gray';
  let responseTime = '--';
  let lastCheck = 'Never';
  
  if (lastRow) {
    const isSuccess = lastRow[2] === 'success';
    const keywordFound = lastRow[3] === 'found';
    status = (isSuccess && keywordFound) ? 'up' : (isSuccess ? 'warning' : 'down');
    statusColor = (isSuccess && keywordFound) ? 'green' : (isSuccess ? 'yellow' : 'red');
    responseTime = parseInt(lastRow[1]).toLocaleString() + ' ms';
    
    const checkDate = new Date(lastRow[0]);
    lastCheck = timeAgo(checkDate);
  }
  
  // Create sparkline canvas
  const canvasId = `chart-${monitor.id}`;
  
  card.innerHTML = `
    <div class="flex items-center gap-4">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 mb-1">
          <h2 class="text-lg font-semibold truncate">${monitor.name}</h2>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
            ${status === 'up' ? '<i class="fa-solid fa-circle-check"></i> Up' : 
              status === 'warning' ? '<i class="fa-solid fa-triangle-exclamation"></i> Warning' :
              status === 'down' ? '<i class="fa-solid fa-circle-xmark"></i> Down' : 
              '<i class="fa-solid fa-question"></i> Unknown'}
          </span>
        </div>
        <div class="text-sm text-gray-600 flex gap-4 flex-wrap">
          <span class="truncate"><i class="fa-solid fa-link"></i> ${monitor.url}</span>
          <span><i class="fa-solid fa-clock"></i> ${responseTime}</span>
          <span><i class="fa-solid fa-calendar"></i> ${lastCheck}</span>
        </div>
      </div>
      <div class="w-48 h-8 flex-shrink-0">
        <canvas id="${canvasId}" style="height: 32px;"></canvas>
      </div>
    </div>
  `;
  
  // Draw sparkline chart after card is added to DOM
  setTimeout(() => {
    if (rows.length > 0) {
      drawSparkline(canvasId, rows);
    }
  }, 10);
  
  return card;
}

function drawSparkline(canvasId, rows) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const data = rows.slice(-20).map(r => parseInt(r[1])); // Last 20 data points
  const bgColors = rows.slice(-20).map(r => 
    (r[2]==='success' && r[3]==='found') ? '#4CAF50' : 
    (r[2]==='success' ? '#FFC107' : '#f44336')
  );
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map((_, i) => i),
      datasets: [{
        data: data,
        fill: false,
        borderColor: '#1976d2',
        backgroundColor: '#1976d2',
        pointBackgroundColor: bgColors,
        pointRadius: 3,
        pointHoverRadius: 5,
        tension: 0.2,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { display: false },
        tooltip: { enabled: false }
      },
      scales: {
        y: { display: false, beginAtZero: true },
        x: { display: false }
      },
      elements: {
        line: {
          borderWidth: 2
        }
      }
    }
  });
}

function timeAgo(date) {
  const now = new Date();
  const seconds = Math.floor((now - date) / 1000);
  if (seconds < 60) return `${seconds}s ago`;
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}
</script>
</body>
</html>
