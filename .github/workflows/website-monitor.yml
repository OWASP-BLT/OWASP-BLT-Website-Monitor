name: Website Monitor

# Example configuration (edit these values to change the default monitoring settings)
env:
  DEFAULT_WEBSITE_URL: 'https://owaspblt.org'
  DEFAULT_KEYWORD: 'OWASP'

on:
  push:
  schedule:
    - cron: '*/5 * * * *'  # Run every 5 minutes
  workflow_dispatch:  # Allow manual triggering
    inputs:
      website_url:
        description: 'Website URL to monitor (default: https://owasp.org)'
        required: false
        default: 'https://owasp.org'
      keyword:
        description: 'Keyword to check for in website content (default: OWASP)'
        required: false
        default: 'OWASP'

# Set the permissions for the workflow
permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags

      - name: Monitor website
        id: monitor
        run: |
          start_time=$(date +%s%3N)
          content=$(curl -s "${{ github.event.inputs.website_url || env.DEFAULT_WEBSITE_URL }}")
          response_code=$(curl -s -o /dev/null -w "%{http_code}" "${{ github.event.inputs.website_url || env.DEFAULT_WEBSITE_URL }}")
          end_time=$(date +%s%3N)
          duration_ms=$((end_time - start_time))
          duration_s=$(awk "BEGIN {printf \"%.3f\", $duration_ms/1000}")

          if echo "$content" | grep -qi "${{ github.event.inputs.keyword || env.DEFAULT_KEYWORD }}"; then
            keyword_status="found"
          else
            keyword_status="not_found"
          fi

          # Check for Cloudflare captcha message
          cloudflare_captcha=false
          if echo "$content" | grep -qi "Verify you are human by completing the action below"; then
            cloudflare_captcha=true
          fi

          # Success if keyword found OR Cloudflare captcha detected (site is live)
          if [ "$keyword_status" == "found" ] || [ "$cloudflare_captcha" == "true" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "duration_ms=$duration_ms" >> $GITHUB_OUTPUT
            echo "duration_s=$duration_s" >> $GITHUB_OUTPUT
            echo "keyword_status=$keyword_status" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "duration_ms=$duration_ms" >> $GITHUB_OUTPUT
            echo "duration_s=$duration_s" >> $GITHUB_OUTPUT
            echo "keyword_status=$keyword_status" >> $GITHUB_OUTPUT
          fi

      - name: Update status file
        run: |
          now_iso=$(date -Iseconds)
          if [ ! -s status.csv ]; then
            echo "datetime,duration_ms,status,keyword_status" > status.csv
          fi
          echo "$now_iso,${{ steps.monitor.outputs.duration_ms }},${{ steps.monitor.outputs.status }},${{ steps.monitor.outputs.keyword_status }}" >> status.csv
          # Keep only last 30 rows (plus header)
          head -n 1 status.csv > status.csv.tmp
          tail -n 30 status.csv >> status.csv.tmp
          mv status.csv.tmp status.csv

      # Note: index.html generation was removed to support the new multi-monitor homepage
      # index.html is now a static page that lists all monitors from monitors.json
      # monitor.html dynamically loads monitor details based on URL parameter

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add status.csv
          git commit -m "Update website monitor status" || true
          git pull --rebase origin main || true
          git push origin main

      - name: Notify Slack on failure
        if: steps.monitor.outputs.status == 'failure' || steps.monitor.outputs.keyword_status == 'not_found'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "⚠️ Website Monitor Alert\n${{ steps.monitor.outputs.status == 'failure' && 'Website is down!' || 'Keyword not found!' }}\nLast check: ${{ steps.monitor.outputs.duration_s }}s\nResponse time: ${{ steps.monitor.outputs.duration_s }} seconds\nKeyword status: ${{ steps.monitor.outputs.keyword_status }}\nWebsite: ${{ github.event.inputs.website_url || env.DEFAULT_WEBSITE_URL }}\nKeyword: ${{ github.event.inputs.keyword || env.DEFAULT_KEYWORD }}\nMonitor Dashboard: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
